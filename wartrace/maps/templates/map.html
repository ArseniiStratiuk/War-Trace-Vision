<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>War Trace Vision</title>
  {% load static %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <link rel="stylesheet" href="{% static 'css/map.css' %}" />
</head>
<body>
  <div id="map"></div>

  <!-- App Header -->
  <div class="app-header">
    <h1>War Trace Vision</h1>
    <div class="status">Live • Analyzing</div>
  </div>

  <!-- Menu Button -->
  <div class="menu-button">
    <svg viewBox="0 0 24 24">
      <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
    </svg>
  </div>

  <!-- Left Toolbar -->
  <div class="toolbar">
    <button id="marker-btn" title="Add Annotation">
      <svg viewBox="0 0 24 24">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
      </svg>
    </button>
    <button id="search-btn" title="Search Location">
      <svg viewBox="0 0 24 24">
        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
      </svg>
    </button>
    <button id="filter-btn" title="Filter Markers">
      <svg viewBox="0 0 24 24">
        <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
      </svg>
    </button>
    <div class="toolbar-divider"></div>
    <button id="draw-btn" title="Draw Area">
      <svg viewBox="0 0 24 24">
        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
      </svg>
    </button>
    <button id="ruler-btn" title="Measure">
      <svg viewBox="0 0 24 24">
        <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 10H3V8h2v4h2V8h2v4h2V8h2v4h2V8h2v4h2V8h2v8z"/>
      </svg>
    </button>
    <button id="ai-btn" title="AI Detection">
      <svg viewBox="0 0 24 24">
        <path d="M21 11c0-.55-.45-1-1-1h-1V7l-2-2H7L5 7v3H4c-.55 0-1 .45-1 1s.45 1 1 1h1v2c0 .55.45 1 1 1h1v2h2v-2h6v2h2v-2h1c.55 0 1-.45 1-1v-2h1c.55 0 1-.45 1-1zm-5 2H8v-2h8v2zm0-4H8V8h8v1z"/>
      </svg>
    </button>
    <button id="layers-btn" title="Map Layers">
      <svg viewBox="0 0 24 24">
        <path d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"/>
      </svg>
    </button>
    <button id="legend-btn" title="Show Legend">
      <svg viewBox="0 0 24 24">
        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
      </svg>
    </button>
    <button id="zoom-in-btn" title="Zoom In">
      <svg viewBox="0 0 24 24">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
      </svg>
    </button>
    <button id="zoom-out-btn" title="Zoom Out">
      <svg viewBox="0 0 24 24">
        <path d="M19 13H5v-2h14v2z"/>
      </svg>
    </button>
  </div>

  <div class="filter-panel">
    <div class="filter-header">
      <h3>Filter Markers</h3>
      <button id="close-filter">×</button>
    </div>
    <div class="filter-content">
      <div class="filter-group">
        <label>Category:</label>
        <select id="filter-category">
          <option value="">All Categories</option>
          <option value="infrastructure">Infrastructure Damage</option>
          <option value="military">Military Objects</option>
          <option value="hazard">Hazard Areas</option>
          <option value="residential">Residential Damage</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Verification:</label>
        <select id="filter-verification">
          <option value="">All Statuses</option>
          <option value="verified">Verified</option>
          <option value="unverified">Unverified</option>
          <option value="ai-detected">AI Detected</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Date Range:</label>
        <input type="date" id="filter-start-date" placeholder="Start Date">
        <input type="date" id="filter-end-date" placeholder="End Date">
      </div>
      <button id="apply-filters">Apply Filters</button>
      <button id="reset-filters">Reset Filters</button>
    </div>
  </div>

  <!-- Map Controls -->
  <div class="map-controls">
    <button id="satellite-btn" title="Satellite View">
      <svg viewBox="0 0 24 24">
        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm-7 7H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4z"/>
      </svg>
    </button>
    <button id="dark-mode-btn" title="Toggle Dark Mode">
      <svg viewBox="0 0 24 24">
        <path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/>
      </svg>
    </button>
  </div>

  <!-- Map Legend -->
  <div class="map-legend">
    <h4>Damage Categories</h4>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #E57373;"></div>
      <div class="legend-text">Infrastructure Damage</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #7B1FA2;"></div>
      <div class="legend-text">Military Objects</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #FFA000;"></div>
      <div class="legend-text">Hazard Areas</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #388E3C;"></div>
      <div class="legend-text">Residential Damage</div>
    </div>
    <div class="toolbar-divider"></div>
    <h4>Verification Status</h4>
    <div class="legend-item">
      <div class="status-verified">Verified</div>
      <div class="legend-text">Community Verified</div>
    </div>
    <div class="legend-item">
      <div class="status-unverified">Unverified</div>
      <div class="legend-text">Awaiting Verification</div>
    </div>
    <div class="legend-item">
      <div class="status-ai-detected">AI Detected</div>
      <div class="legend-text">AI Analysis</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script>
  // Initialize map
  const map = L.map('map', {
    zoomControl: false  // Disable default zoom controls
  }).setView([48.3794, 31.1656], 6);

  // Set attributions with more relevant text for this project
  const attributionText = '© OpenStreetMap contributors | Imagery Analysis Platform for War Documentation';

  // Regular map layer - OpenStreetMap with custom attribution
  const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: attributionText,
    maxZoom: 19
  });

  // More detailed standard layer - OpenStreetMap Humanitarian style for better detail
  const detailedLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    attribution: attributionText,
    maxZoom: 19
  }).addTo(map);

  // Satellite layer with appropriate attribution
  const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: attributionText + ' | Satellite imagery from Esri',
    maxZoom: 19
  });

  // Labels layer for satellite mode
  const labelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
    attribution: attributionText,
    maxZoom: 19,
    pane: 'shadowPane'  // Place labels above the satellite imagery
  });

  // Add scale control
  L.control.scale({
    imperial: false,
    position: 'bottomleft'
  }).addTo(map);

  // Layer for all markers
  const markers = L.layerGroup().addTo(map);

  // Helper function to truncate text
  function truncateText(text, maxLength) {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
  }

  // Function to create marker with proper tooltip
  function createMarker(item) {
    const markerClass = `marker-${item.category}`;
    
    const icon = L.divIcon({
      className: markerClass,
      iconSize: [12, 12]
    });
    
    const marker = L.marker([item.lat, item.lng], {
      icon: icon
    });
    
    const verificationStatus = item.verification === 'verified' ? 
      '<span class="status-verified">Verified</span>' : 
      (item.verification === 'ai-detected' ? 
        '<span class="status-ai-detected">AI Detected</span>' : 
        '<span class="status-unverified">Unverified</span>');
    
    // Truncate description to 60 characters
    const truncatedDescription = truncateText(item.description, 60);
    
    // Truncate source to 32 characters
    const truncatedSource = truncateText(item.source, 30);
    
    const tooltipContent = `
      <div class="tooltip">
        <h3>${item.title} ${verificationStatus}</h3>
        <p class="truncated-text" title="${item.description}">${truncatedDescription}</p>
        <p class="confidence">Confidence: ${item.confidence}</p>
        <p class="date" title="Date: ${item.date}">Date: ${item.date}</p>
        <p class="source" title="Source: ${item.source}">Source: ${truncatedSource}</p>
        <p class="user">By: ${item.user}</p>
      </div>
    `;
    
    marker.bindTooltip(tooltipContent, {
      permanent: false,
      direction: 'top',
      offset: [0, -10],
      opacity: 1
    });
    
    // Add click handler to view marker details
    marker.on('click', function() {
      window.location.href = `{% url "marker_detail" pk=0 %}`.replace('0', item.id);
    });
    
    return marker;
  }

  // Store the current markers data
  let currentMarkersData = [];

  // Function to load markers via AJAX
  function loadMarkers() {
    // Show loading indicator in status
    document.querySelector('.app-header .status').textContent = 'Loading markers...';
    
    // Make AJAX request to the marker_api endpoint
    fetch('{% url "marker_api" %}')
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Store the complete markers data
        currentMarkersData = data.markers || [];
        
        // Clear existing markers
        markers.clearLayers();
        
        // Add new markers from the API response
        if (currentMarkersData.length > 0) {
          currentMarkersData.forEach(item => {
            const marker = createMarker(item);
            marker.addTo(markers);
          });
          
          // Update status to show number of markers
          document.querySelector('.app-header .status').textContent = 
            `Live • ${currentMarkersData.length} markers loaded`;
        } else {
          // No markers found
          document.querySelector('.app-header .status').textContent = 
            'Live • No markers available';
        }
      })
      .catch(error => {
        console.error('Error loading markers:', error);
        document.querySelector('.app-header .status').textContent = 
          'Error loading markers';
      });
  }

  // Function to filter markers locally using the stored data
  function filterMarkers() {
    // Get filter values
    const categoryFilter = document.getElementById('filter-category').value;
    const verificationFilter = document.getElementById('filter-verification').value;
    const startDateFilter = document.getElementById('filter-start-date').value;
    const endDateFilter = document.getElementById('filter-end-date').value;
    
    // Show filtering status
    document.querySelector('.app-header .status').textContent = 'Filtering markers...';
    
    // Clear existing markers
    markers.clearLayers();
    
    // Apply filters to current data
    const filteredMarkers = currentMarkersData.filter(item => {
      // Check category filter
      if (categoryFilter && item.category !== categoryFilter) {
        return false;
      }
      
      // Check verification filter
      if (verificationFilter && item.verification !== verificationFilter) {
        return false;
      }
      
      // Check date range
      if (startDateFilter || endDateFilter) {
        const itemDate = new Date(item.date);
        
        if (startDateFilter) {
          const startDate = new Date(startDateFilter);
          if (itemDate < startDate) {
            return false;
          }
        }
        
        if (endDateFilter) {
          const endDate = new Date(endDateFilter);
          // Set time to end of day for inclusive end date
          endDate.setHours(23, 59, 59, 999);
          if (itemDate > endDate) {
            return false;
          }
        }
      }
      
      // All filters passed
      return true;
    });
    
    // Add filtered markers
    if (filteredMarkers.length > 0) {
      filteredMarkers.forEach(item => {
        const marker = createMarker(item);
        marker.addTo(markers);
      });
      
      // Update status to show filtered results
      document.querySelector('.app-header .status').textContent = 
        `Live • ${filteredMarkers.length} markers displayed`;
    } else {
      // No markers match the filter
      document.querySelector('.app-header .status').textContent = 
        'No markers match your filters';
    }
    
    // Close the filter panel
    document.querySelector('.filter-panel').style.display = 'none';
  }

  // Variables to track UI state
  let isDarkMode = false;
  let isSatelliteMode = false;
  let isLegendVisible = false;
  let isAiPanelVisible = false;

  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
    // Initial status indicator
    document.querySelector('.app-header .status').innerHTML = '<span class="spinner"></span> Initializing...';
    
    // Initial marker load
    loadMarkers();
    
    // Set up auto-refresh every 60 seconds
    setInterval(loadMarkers, 60000);
    
    // Set up connection status check
    setInterval(() => {
      // Check connectivity
      const isOnline = navigator.onLine;
      const statusElement = document.querySelector('.app-header .status');
      
      if (!isOnline) {
        statusElement.innerHTML = '<span style="color: red;">⚠ Offline</span>';
      }
    }, 30000);

    // Filter panel toggle
    document.getElementById('filter-btn').addEventListener('click', function() {
      document.querySelector('.filter-panel').style.display = 'block';
    });

    document.getElementById('close-filter').addEventListener('click', function() {
      document.querySelector('.filter-panel').style.display = 'none';
    });

    // Apply filters
    document.getElementById('apply-filters').addEventListener('click', filterMarkers);

    // Reset filters
    document.getElementById('reset-filters').addEventListener('click', function() {
      // Clear all filter inputs
      document.getElementById('filter-category').value = '';
      document.getElementById('filter-verification').value = '';
      document.getElementById('filter-start-date').value = '';
      document.getElementById('filter-end-date').value = '';
      
      // Reset to show all markers
      markers.clearLayers();
      currentMarkersData.forEach(item => {
        const marker = createMarker(item);
        marker.addTo(markers);
      });
      
      // Update status
      document.querySelector('.app-header .status').textContent = 
        `Live • ${currentMarkersData.length} markers displayed`;
      
      // Close the filter panel
      document.querySelector('.filter-panel').style.display = 'none';
    });

    // Add "Add Marker" button functionality
    document.getElementById('marker-btn').addEventListener('click', function() {
      window.location.href = '{% url "marker_create" %}';
    });

    // Toggle dark mode
    document.getElementById('dark-mode-btn').addEventListener('click', function() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode', isDarkMode);
      
      // Update the dark mode button icon
      this.innerHTML = isDarkMode ? 
        '<svg viewBox="0 0 24 24"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>' : 
        '<svg viewBox="0 0 24 24"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg>';
    });
    
    // Toggle satellite mode
    document.getElementById('satellite-btn').addEventListener('click', function() {
      isSatelliteMode = !isSatelliteMode;
      
      if (isSatelliteMode) {
        map.removeLayer(detailedLayer);
        map.removeLayer(osmLayer);
        satelliteLayer.addTo(map);
        labelsLayer.addTo(map);
      } else {
        map.removeLayer(satelliteLayer);
        map.removeLayer(labelsLayer);
        detailedLayer.addTo(map);
      }
      
      // Update button state
      this.classList.toggle('active', isSatelliteMode);
    });
    
    // Toggle legend visibility
    document.getElementById('legend-btn').addEventListener('click', function() {
      isLegendVisible = !isLegendVisible;
      document.querySelector('.map-legend').style.display = isLegendVisible ? 'block' : 'none';
    });
    
    // Zoom controls
    document.getElementById('zoom-in-btn').addEventListener('click', function() {
      map.zoomIn();
    });
    
    document.getElementById('zoom-out-btn').addEventListener('click', function() {
      map.zoomOut();
    });
    
    // Open AI analysis panel
    document.getElementById('ai-btn').addEventListener('click', function() {
      isAiPanelVisible = true;
      document.querySelector('.ai-analysis-panel').style.display = 'block';
    });
    
    // Close AI analysis panel
    document.getElementById('close-ai-panel').addEventListener('click', function() {
      isAiPanelVisible = false;
      document.querySelector('.ai-analysis-panel').style.display = 'none';
    });
    
    // Try to get user location if available
    try {
      navigator.geolocation.getCurrentPosition(function(position) {
        const userIcon = L.divIcon({
          className: 'user-location',
          iconSize: [20, 20]
        });
        
        L.marker([position.coords.latitude, position.coords.longitude], {
          icon: userIcon
        }).addTo(map).bindTooltip("Your Location", {
          permanent: false,
          direction: 'top'
        });
      }, function() {
        // Geolocation error or denied
        console.log("Geolocation not available or denied");
      });
    } catch (e) {
      console.log("Geolocation not supported");
    }
    
    // Simulate drawing mode
    document.getElementById('draw-btn').addEventListener('click', function() {
      alert("Drawing mode would allow users to outline damaged areas. This functionality requires additional libraries.");
    });
    
    // Simulate measurement tool
    document.getElementById('ruler-btn').addEventListener('click', function() {
      alert("Measurement tool would allow distance and area calculation. This functionality requires additional libraries.");
    });
    
    // Simulate search functionality
    document.getElementById('search-btn').addEventListener('click', function() {
      const location = prompt("Enter location to search:", "");
      if (location) {
        alert(`Search functionality would locate "${location}" on the map. This requires geocoding integration.`);
      }
    });
    
    // Simulate layer control
    document.getElementById('layers-btn').addEventListener('click', function() {
      alert("Layer control would allow toggling between different data layers like heat maps, damage density, etc.");
    });
    
    // Add a menu button functionality
    document.querySelector('.menu-button').addEventListener('click', function() {
      // This would normally open a full menu, but for simplicity we'll just toggle the toolbar
      document.querySelector('.toolbar').classList.toggle('expanded');
    });
  });
  </script>
</body>
</html>