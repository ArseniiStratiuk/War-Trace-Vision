{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Marker Detail - War Trace Vision</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% csrf_token %}
</head>
<body>
    <h1>{{ marker.title }}</h1>
    
    <div>
        <p><strong>Description:</strong> {{ marker.description }}</p>
        <p><strong>Location:</strong> {{ marker.latitude }}, {{ marker.longitude }}</p>
        <p><strong>Date:</strong> {{ marker.date|date:"Y-m-d" }}</p>
        <p><strong>Category:</strong> {{ marker.category }}</p>
        <p><strong>Source:</strong> {{ marker.source }}</p>
        <p><strong>Status:</strong> {{ marker.verification }}</p>
    </div>
    
    <h2>Media Files</h2>
    
    {% if marker.files.exists %}
        <div>
            <h3>Original Files</h3>
            <div>
                {% for file in marker.files.all %}
                    {% if not file.file.name|slice:"-30:" == "object_detection" and not file.file.name|slice:"-30:" == "military_detection" %}
                        <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc;">
                            {% if file.file.url|slice:"-4:" == ".jpg" or file.file.url|slice:"-5:" == ".jpeg" or file.file.url|slice:"-4:" == ".png" %}
                                <img src="{{ file.file.url }}" alt="Media file" style="max-width: 300px; max-height: 300px;">
                            {% else %}
                                <p>Non-image file: {{ file.file.name }}</p>
                            {% endif %}
                            <p>Uploaded: {{ file.uploaded_at|date:"Y-m-d" }}</p>
                            
                            {% if marker.object_detection or marker.military_detection or marker.damage_assessment or marker.emergency_recognition %}
                                {% if file.detections.exists %}
                                    <button class="process-file-btn processed" data-id="{{ file.id }}" disabled>Already Processed</button>
                                {% else %}
                                    <button class="process-file-btn" data-id="{{ file.id }}">Process with AI</button>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            <h3>AI-Processed Images</h3>
            <div>
                {% for file in marker.files.all %}
                    {% if file.file.name|slice:"-30:" == "object_detection" or file.file.name|slice:"-30:" == "military_detection" %}
                        <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc;">
                            <img src="{{ file.file.url }}" alt="AI-processed image" style="max-width: 300px; max-height: 300px;">
                            <p>Processed: {{ file.uploaded_at|date:"Y-m-d" }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        {% if marker.object_detection or marker.military_detection or marker.damage_assessment or marker.emergency_recognition %}
            {% if marker.files.exists and user.is_authenticated and marker.user == user %}
                <button id="process-all-files-btn">Process All Files with AI</button>
            {% endif %}
        {% endif %}
    {% else %}
        <p>No media files available</p>
    {% endif %}
    
    {% if user.is_authenticated and marker.user == user %}
        <div style="margin-top: 20px;">
            <form id="add-media-form" method="post" enctype="multipart/form-data" style="display:none;">
                {% csrf_token %}
                <input type="file" name="file" id="media-file-input" multiple>
            </form>
            <button id="add-media-trigger">Add Media Files</button>
        </div>
    {% endif %}
    
    <h2>Comments ({{ comments|length }})</h2>
    <div>
        {% for comment in comments %}
            <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #eee;">
                <p><strong>{{ comment.user.username }}</strong> - {{ comment.created_at|date:"Y-m-d" }}</p>
                <p>{{ comment.text }}</p>
            </div>
        {% empty %}
            <p>No comments yet</p>
        {% endfor %}
    </div>
    
    {% if user.is_authenticated %}
        <div style="margin-top: 20px;">
            <h3>Add Comment</h3>
            <textarea id="comment-text" rows="3" style="width: 100%;" placeholder="Write your comment..."></textarea>
            <button class="submit-comment-btn">Submit Comment</button>
        </div>
    {% endif %}
    
    <div style="margin-top: 20px;">
        <a href="{% url 'index' %}">Back to Map</a>
        
        {% if user.is_authenticated and marker.user == user %}
            <a href="{% url 'edit_marker' marker.id %}" style="margin-left: 10px;">Edit Marker</a>
            <button class="delete-btn" data-id="{{ marker.id }}" style="margin-left: 10px;">Delete Marker</button>
        {% endif %}
    </div>
    
    <script>
        // Make CSRF token available for AJAX requests
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Handle marker deletion
        const deleteButton = document.querySelector('.delete-btn');
        if (deleteButton) {
            deleteButton.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this marker?')) {
                    const markerId = this.getAttribute('data-id');
                    
                    fetch(`/content/marker/${markerId}/delete/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '/';
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting marker:', error);
                    });
                }
            });
        }
    </script>
    
    <script src="{% static 'js/marker-processing.js' %}"></script>
</body>
</html>